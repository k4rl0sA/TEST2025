<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Roles</title>
    <link rel="stylesheet" href="lib/css/app.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <span class="logo">Administración de Roles</span>
        </header>
        <div class="main-layout">
            <div class="filters-card">
                <h2>Nuevo / Editar Rol</h2>
                <form id="role-form" class="form-section">
                    <div class="form-row">
                        <div class="input-group">
                            <input type="hidden" id="id_rol">
                            <input type="text" id="modulo" required placeholder=" " maxlength="15">
                            <label for="modulo">Módulo</label>
                        </div>
                        <div class="input-group">
                            <input type="text" id="perfil" required placeholder=" " maxlength="11">
                            <label for="perfil">Perfil</label>
                        </div>
                        <div class="input-group">
                            <input type="text" id="componente" required placeholder=" " maxlength="3">
                            <label for="componente">Componente</label>
                        </div>
                        <div class="input-group">
                            <select id="consultar" required>
                                <option value="">Consultar</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="consultar">Consultar</label>
                        </div>
                        <div class="input-group">
                            <select id="editar" required>
                                <option value="">Editar</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="editar">Editar</label>
                        </div>
                        <div class="input-group">
                            <select id="crear" required>
                                <option value="">Crear</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="crear">Crear</label>
                        </div>
                        <div class="input-group">
                            <select id="ajustar" required>
                                <option value="">Ajustar</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="ajustar">Ajustar</label>
                        </div>
                        <div class="input-group">
                            <select id="importar" required>
                                <option value="">Importar</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="importar">Importar</label>
                        </div>
                        <div class="input-group">
                            <select id="estado" required>
                                <option value="">Estado</option>
                                <option value="A">Activo</option>
                                <option value="I">Inactivo</option>
                            </select>
                            <label for="estado">Estado</label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                        <button type="button" class="btn btn-outline" id="reset-btn">Limpiar</button>
                    </div>
                </form>
            </div>
            <div class="content-card">
                <div class="table-header">
                    <h2>Roles Registrados</h2>
                    <button class="btn btn-add" id="add-btn">+ Nuevo Rol</button>
                </div>
                <div class="table-container">
                    <table id="roles-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Módulo</th>
                                <th>Perfil</th>
                                <th>Componente</th>
                                <th>Consultar</th>
                                <th>Editar</th>
                                <th>Crear</th>
                                <th>Ajustar</th>
                                <th>Importar</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Aquí se cargan los roles -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="toast-container"></div>
    </div>
    <script src="lib/js/app.js"></script>
    <script>
        // --- CRUD JS ---
        let editingId = null;

        function fetchRoles() {
            fetch('lib/php/roles_crud.php?a=list')
                .then(res => res.json())
                .then(data => {
                    renderRolesTable(data);
                });
        }

        function renderRolesTable(roles) {
            const tbody = document.querySelector('#roles-table tbody');
            tbody.innerHTML = '';
            roles.forEach(role => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${role.id_rol}</td>
                    <td>${role.modulo}</td>
                    <td>${role.perfil}</td>
                    <td>${role.componente}</td>
                    <td>${role.consultar}</td>
                    <td>${role.editar}</td>
                    <td>${role.crear}</td>
                    <td>${role.ajustar}</td>
                    <td>${role.importar}</td>
                    <td>${role.estado}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editRole(${role.id_rol})"><i class="fa fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteRole(${role.id_rol})"><i class="fa fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('role-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            if (editingId) formData.append('id_rol', editingId);
            fetch('lib/php/roles_crud.php?a=' + (editingId ? 'update' : 'create'), {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Rol guardado correctamente', 'success');
                    fetchRoles();
                    this.reset();
                    editingId = null;
                } else {
                    showToast(data.error || 'Error al guardar', 'error');
                }
            });
        });

        document.getElementById('reset-btn').onclick = function() {
            document.getElementById('role-form').reset();
            editingId = null;
        };

        document.getElementById('add-btn').onclick = function() {
            document.getElementById('role-form').reset();
            editingId = null;
        };

        window.editRole = function(id) {
            fetch('lib/php/roles_crud.php?a=get&id=' + id)
                .then(res => res.json())
                .then(role => {
                    editingId = role.id_rol;
                    document.getElementById('id_rol').value = role.id_rol;
                    document.getElementById('modulo').value = role.modulo;
                    document.getElementById('perfil').value = role.perfil;
                    document.getElementById('componente').value = role.componente;
                    document.getElementById('consultar').value = role.consultar;
                    document.getElementById('editar').value = role.editar;
                    document.getElementById('crear').value = role.crear;
                    document.getElementById('ajustar').value = role.ajustar;
                    document.getElementById('importar').value = role.importar;
                    document.getElementById('estado').value = role.estado;
                });
        };

        window.deleteRole = function(id) {
            if (!confirm('¿Está seguro de eliminar este rol?')) return;
            fetch('lib/php/roles_crud.php?a=delete&id=' + id, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast('Rol eliminado', 'success');
                        fetchRoles();
                    } else {
                        showToast(data.error || 'Error al eliminar', 'error');
                    }
                });
        };

        // Inicializar tabla al cargar
        fetchRoles();
    </script>
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
</body>
</html>