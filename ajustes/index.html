<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Roles</title>
    <link rel="stylesheet" href="../lib/css/app.css?v=21">
    <link rel="stylesheet" href="../lib/css/choices.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
   
        <div class="toast-container"></div>
    <script src="lib/js/app.js"></script>
    <script>
        // --- CRUD JS ---
        let editingId = null;

        function fetchRoles() {
            fetch('lib/php/roles_crud.php?a=list')
                .then(res => res.json())
                .then(data => {
                    renderRolesTable(data);
                });
        }

        function renderRolesTable(roles) {
            const tbody = document.querySelector('#roles-table tbody');
            tbody.innerHTML = '';
            roles.forEach(role => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${role.id_rol}</td>
                    <td>${role.modulo}</td>
                    <td>${role.perfil}</td>
                    <td>${role.componente}</td>
                    <td>${role.consultar}</td>
                    <td>${role.editar}</td>
                    <td>${role.crear}</td>
                    <td>${role.ajustar}</td>
                    <td>${role.importar}</td>
                    <td>${role.estado}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editRole(${role.id_rol})"><i class="fa fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteRole(${role.id_rol})"><i class="fa fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('role-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            if (editingId) formData.append('id_rol', editingId);
            fetch('lib/php/roles_crud.php?a=' + (editingId ? 'update' : 'create'), {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Rol guardado correctamente', 'success');
                    fetchRoles();
                    this.reset();
                    editingId = null;
                } else {
                    showToast(data.error || 'Error al guardar', 'error');
                }
            });
        });

        document.getElementById('reset-btn').onclick = function() {
            document.getElementById('role-form').reset();
            editingId = null;
        };

        document.getElementById('add-btn').onclick = function() {
            document.getElementById('role-form').reset();
            editingId = null;
        };

        window.editRole = function(id) {
            fetch('lib/php/roles_crud.php?a=get&id=' + id)
                .then(res => res.json())
                .then(role => {
                    editingId = role.id_rol;
                    document.getElementById('id_rol').value = role.id_rol;
                    document.getElementById('modulo').value = role.modulo;
                    document.getElementById('perfil').value = role.perfil;
                    document.getElementById('componente').value = role.componente;
                    document.getElementById('consultar').value = role.consultar;
                    document.getElementById('editar').value = role.editar;
                    document.getElementById('crear').value = role.crear;
                    document.getElementById('ajustar').value = role.ajustar;
                    document.getElementById('importar').value = role.importar;
                    document.getElementById('estado').value = role.estado;
                });
        };

        window.deleteRole = function(id) {
            if (!confirm('¿Está seguro de eliminar este rol?')) return;
            fetch('lib/php/roles_crud.php?a=delete&id=' + id, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast('Rol eliminado', 'success');
                        fetchRoles();
                    } else {
                        showToast(data.error || 'Error al eliminar', 'error');
                    }
                });
        };

        // Inicializar tabla al cargar
        fetchRoles();
    </script>
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <script src="../lib/js/choices.min.js"></script>
</body>
</html>