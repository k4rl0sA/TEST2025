<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Roles</title>
    <link rel="stylesheet" href="../lib/css/app.css?v=2">
    <link rel="stylesheet" href="../lib/css/choices.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<style>
    .filters-bar {
    display: flex;
    align-items: center;
    gap: 1em;
    margin-bottom: 1em;
}
.btn-chip {
    background: #1a1aff;
    color: #fff;
    border-radius: 20px;
    padding: 0.4em 1.2em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5em;
    border: none;
    cursor: pointer;
    position: relative;
}
.chip-count {
    background: #fff;
    color: #1a1aff;
    border-radius: 50%;
    padding: 0.1em 0.6em;
    font-size: 0.95em;
    margin-left: 0.3em;
    font-weight: 700;
}
.chips-list {
    display: flex;
    gap: 0.5em;
    flex-wrap: wrap;
}
.chip {
    background: #f4f6fb;
    color: #222;
    border-radius: 18px;
    padding: 0.3em 1em 0.3em 0.8em;
    font-size: 0.97em;
    display: flex;
    align-items: center;
    gap: 0.5em;
    border: 1px solid #e5e8ef;
}
.chip .chip-remove {
    background: none;
    border: none;
    color: #888;
    font-size: 1em;
    cursor: pointer;
    margin-left: 0.2em;
}
.chip .chip-remove:hover {
    color: #d00;
}
</style>
<body>
    <div class="container">
        <header>
            <span class="logo">Administración de Roles</span>
        </header>
        <div class="main-layout">
            <!-- Zona de filtros con apariencia moderna -->
            <!-- <div class="filters-card custom-filters" id="filters-panel">
                <h2><i class="fa-solid fa-filter"></i>Filtros</h2>
                <form id="filter-form">
                    <div class="filter-group">
                        <label for="fil-search">Buscar</label>
                        <input type="text" id="fil-search" placeholder="Ingrese término...">
                    </div>
                    <div class="filter-group">
                        <label for="fil-modulo">Módulo</label>
                        <input type="text" id="fil-modulo" placeholder=" ">
                    </div>
                    <div class="filter-group">
                        <label for="fil-perfil">Perfil</label>
                        <input type="text" id="fil-perfil" placeholder=" ">
                    </div>
                    <div class="filter-group">
                        <label for="fil-estado">Estado</label>
                            <select id="fil-estado">
                            </select>
                        </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary filter-btn">
                            <i class="fa fa-search"></i> Aplicar Filtros
                        </button>
                        <button type="button" class="btn btn-outline filter-reset" id="clear-filters">
                            <i class="fa fa-sync"></i>
                        </button>
                    </div>
                </form>
            </div> -->
            <!-- Zona de tabla -->
            <div class="content-card" id="table-section">
                <div class="table-header">
                    <h2>Roles Registrados</h2>
                    <button class="btn action-btn" id="toggle-filters-btn"><i class="fas fa-filter"></i> Filtros</button>
                    <button class="btn" id="toggle-filters-btn"><i class="fas fa-filter"></i> Filtros</button>
                    <button class="btn btn-add" id="add-btn">+ Nuevo Rol</button>
                </div>
                <div class="table-container">
                    <table id="roles-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Módulo</th>
                                <th>Perfil</th>
                                <th>Componente</th>
                                <th>Consultar</th>
                                <th>Editar</th>
                                <th>Crear</th>
                                <th>Ajustar</th>
                                <th>Importar</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Aquí se cargan los roles -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Formulario flotante/modal SPA -->
            <div class="content-card hidden" id="form-section">
                <h2 id="form-title">Nuevo Rol</h2>
                <form id="role-form" class="form-section">
                    <input type="hidden" id="id_rol">
                    <div class="form-row">
                        <div class="input-group">
                            <input type="text" id="modulo" required placeholder=" " maxlength="15">
                            <label for="modulo">Módulo</label>
                        </div>
                        <div class="input-group">
                            <input type="text" id="perfil" required placeholder=" " maxlength="11">
                            <label for="perfil">Perfil</label>
                        </div>
                        <div class="input-group">
                            <input type="text" id="componente" required placeholder=" " maxlength="3">
                            <label for="componente">Componente</label>
                        </div>
                        <div class="input-group">
                            <select id="consultar" required>
                                <option value="">Consultar</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="consultar">Consultar</label>
                        </div>
                        <div class="input-group">
                            <select id="editar" required>
                                <option value="">Editar</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="editar">Editar</label>
                        </div>
                        <div class="input-group">
                            <select id="crear" required>
                                <option value="">Crear</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="crear">Crear</label>
                        </div>
                        <div class="input-group">
                            <select id="ajustar" required>
                                <option value="">Ajustar</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="ajustar">Ajustar</label>
                        </div>
                        <div class="input-group">
                            <select id="importar" required>
                                <option value="">Importar</option>
                                <option value="S">Sí</option>
                                <option value="N">No</option>
                            </select>
                            <label for="importar">Importar</label>
                        </div>
                        <div class="input-group">
                            <select id="estado" required>
                                <option value="">Estado</option>
                                <option value="A">Activo</option>
                                <option value="I">Inactivo</option>
                            </select>
                            <label for="estado">Estado</label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                        <button type="button" class="btn btn-outline" id="cancel-btn">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="toast-container"></div>
    </div>
    <script src="../lib/js/app.js"></script>
    <script>
        let editingId = null;

        function fetchRoles(filters = {}) {
            // Construir query string de filtros
            const params = new URLSearchParams(filters).toString();
            fetch('/agendas/lib.php?a=list' + (params ? '&' + params : ''))
                .then(res => res.json())
                .then(data => renderRolesTable(data));
        }

        function renderRolesTable(roles) {
            const tbody = document.querySelector('#roles-table tbody');
            tbody.innerHTML = '';
            roles.forEach(role => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${role.id_rol}</td>
                    <td>${role.modulo}</td>
                    <td>${role.perfil}</td>
                    <td>${role.componente}</td>
                    <td>${role.consultar}</td>
                    <td>${role.editar}</td>
                    <td>${role.crear}</td>
                    <td>${role.ajustar}</td>
                    <td>${role.importar}</td>
                    <td>${role.estado}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editRole(${role.id_rol})"><i class="fa fa-edit"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteRole(${role.id_rol})"><i class="fa fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Mostrar formulario y ocultar tabla
        function showForm(edit = false) {
            document.getElementById('table-section').classList.add('hidden');
            document.getElementById('form-section').classList.remove('hidden');
            document.getElementById('form-title').textContent = edit ? 'Editar Rol' : 'Nuevo Rol';
        }
        // Ocultar formulario y mostrar tabla
        function hideForm() {
            document.getElementById('form-section').classList.add('hidden');
            document.getElementById('table-section').classList.remove('hidden');
            document.getElementById('role-form').reset();
            editingId = null;
        }

        document.getElementById('add-btn').onclick = function () {
            editingId = null;
            document.getElementById('role-form').reset();
            showForm(false);
        };

        document.getElementById('cancel-btn').onclick = hideForm;

        window.editRole = function (id) {
            fetch('/agendas/lib.php?a=get&id=' + id)
                .then(res => res.json())
                .then(role => {
                    editingId = role.id_rol;
                    document.getElementById('id_rol').value = role.id_rol;
                    document.getElementById('modulo').value = role.modulo;
                    document.getElementById('perfil').value = role.perfil;
                    document.getElementById('componente').value = role.componente;
                    document.getElementById('consultar').value = role.consultar;
                    document.getElementById('editar').value = role.editar;
                    document.getElementById('crear').value = role.crear;
                    document.getElementById('ajustar').value = role.ajustar;
                    document.getElementById('importar').value = role.importar;
                    document.getElementById('estado').value = role.estado;
                    showForm(true);
                });
        };

        window.deleteRole = function (id) {
            if (!confirm('¿Está seguro de eliminar este rol?')) return;
            fetch('/agendas/lib.php?a=delete&id=' + id, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast('Rol eliminado', 'success');
                        fetchRoles();
                    } else {
                        showToast(data.error || 'Error al eliminar', 'error');
                    }
                });
        };

        document.getElementById('role-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            if (editingId) formData.append('id_rol', editingId);
            fetch('/agendas/lib.php?a=' + (editingId ? 'update' : 'create'), {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast('Rol guardado correctamente', 'success');
                        hideForm();
                        fetchRoles();
                    } else {
                        showToast(data.error || 'Error al guardar', 'error');
                    }
                });
        });

        // Filtros
        document.getElementById('filter-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const filters = {
                modulo: document.getElementById('filter-modulo').value,
                perfil: document.getElementById('filter-perfil').value,
                estado: document.getElementById('filter-estado').value
            };
            fetchRoles(filters);
        });
        document.getElementById('clear-filters').onclick = function () {
            document.getElementById('filter-form').reset();
            fetchRoles();
        };

        // Inicializar tabla al cargar
        fetchRoles();





//FILTROS
        const filters = {
    search: '',
    modulo: '',
    perfil: '',
    estado: ''
};

function updateActiveFiltersChips() {
    const chipsList = document.getElementById('active-filters-chips');
    chipsList.innerHTML = '';
    let count = 0;

    // Chips por filtro activo
    if (filters.search) {
        chipsList.appendChild(createChip('Buscar', filters.search, 'search'));
        count++;
    }
    if (filters.modulo) {
        chipsList.appendChild(createChip('Módulo', filters.modulo, 'modulo'));
        count++;
    }
    if (filters.perfil) {
        chipsList.appendChild(createChip('Perfil', filters.perfil, 'perfil'));
        count++;
    }
    if (filters.estado) {
        let label = filters.estado === 'A' ? 'Activo' : 'Inactivo';
        chipsList.appendChild(createChip('Estado', label, 'estado'));
        count++;
    }

    document.getElementById('active-filters-count').textContent = count;
}

function createChip(label, value, key) {
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = `<strong>${label}:</strong> ${value} <button class="chip-remove" title="Quitar filtro" onclick="removeFilter('${key}')">&times;</button>`;
    return chip;
}

// Quitar filtro individual
window.removeFilter = function(key) {
    filters[key] = '';
    // Actualiza los campos del formulario de filtros
    if (key === 'search') document.getElementById('fil-search').value = '';
    if (key === 'modulo') document.getElementById('fil-modulo').value = '';
    if (key === 'perfil') document.getElementById('fil-perfil').value = '';
    if (key === 'estado') document.getElementById('fil-estado').value = '';
    fetchRoles(filters);
    updateActiveFiltersChips();
};

// Mostrar/ocultar panel de filtros
const filtersPanel = document.getElementById('filters-panel');
const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
let filtersVisible = false;
toggleFiltersBtn.onclick = function() {
    filtersVisible = !filtersVisible;
    filtersPanel.classList.toggle('hidden', !filtersVisible);
};

// Al aplicar filtros
document.getElementById('filter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    filters.search = document.getElementById('fil-search').value.trim();
    filters.modulo = document.getElementById('fil-modulo').value.trim();
    filters.perfil = document.getElementById('fil-perfil').value.trim();
    filters.estado = document.getElementById('fil-estado').value;
    fetchRoles(filters);
    updateActiveFiltersChips();
    filtersPanel.classList.add('hidden'); // Oculta filtros tras aplicar
    filtersVisible = false;
});

// Limpiar todos los filtros
document.getElementById('clear-filters').onclick = function() {
    document.getElementById('filter-form').reset();
    filters.search = '';
    filters.modulo = '';
    filters.perfil = '';
    filters.estado = '';
    fetchRoles(filters);
    updateActiveFiltersChips();
};

// Inicializa chips al cargar
updateActiveFiltersChips();
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <script src="../lib/js/choices.min.js"></script>
</body>

</html>