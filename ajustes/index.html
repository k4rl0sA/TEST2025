<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestión de Roles</title>
    <link rel="stylesheet" href="../lib/css/app.css?v=15">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <script>window.CSRF_TOKEN = "<?php echo $_SESSION['csrf_token']; ?>";</script>
</head>
<body>
<div class="content-card">
    <div class='load' id='loader' z-index='0'></div>
    <!-- Filtros tipo chips -->
    <div class="filters-bar">
        <button class="btn btn-chip" id="toggle-filters-btn">
            <i class="fa fa-filter"></i> Filtros <span id="active-filters-count" class="chip-count">0</span>
        </button>
        <div id="active-filters-chips" class="chips-list"></div>
    </div>
    <!-- Panel de filtros -->
    <div class="form-section hidden" id="filters-panel" style="margin-bottom:1.5em;">
        <form id="filter-form" class="filter-section">
            <div class="input-group">
                <input type="text" id="fil-modulo" placeholder="">
                <label for="fil-modulo">Módulo</label>
            </div>
            <div class="input-group">
                <input type="text" id="fil-perfil" placeholder="">
                <label for="fil-perfil">Perfil</label>
            </div>
            <div class="input-group">
                <select id="fil-estado" placeholder=" ">
                </select>
                <label for="fil-estado">Estado</label>
            </div>
            <div class="input-group">
                <input type="text" id="fil-search" placeholder="">
                <label for="fil-search">Buscar</label>
            </div>
            <div class="filter-actions" style="align-self:flex-end;">
                <button type="submit" class="btn btn-primary filter-btn">
                    <i class="fa fa-search"></i> Aplicar Filtros
                </button>
                <button type="button" class="btn btn-outline filter-reset" id="clear-filters">
                    <i class="fa fa-sync"></i>
                </button>
            </div>
        </form>
    </div>
    <!-- Tabla y header -->
    <div class="table-header">
        <h2>Roles Registrados</h2>
        <button class="btn btn-add" id="add-btn">+ Nuevo Rol</button>
    </div>
    <div class="table-container" id="table-section">
        <table id="roles-table">
            <thead>
                <tr>
                    <th>Acciones</th>
                    <th data-sort="id_rol">ID</th>
                    <th data-sort="modulo">Módulo</th>
                    <th data-sort="perfil">Perfil</th>
                    <th data-sort="componente">Componente</th>
                    <th data-sort="consultar">Consultar</th>
                    <th data-sort="editar">Editar</th>
                    <th data-sort="crear">Crear</th>
                    <th data-sort="ajustar">Ajustar</th>
                    <th data-sort="importar">Importar</th>
                    <th data-sort="estado">Estado</th>
                    
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se cargan los roles -->
            </tbody>
        </table>
        <div class="paginator" id="paginator"></div>
    </div>
    

    <div id="modal-bg" class="form-section modal-content hidden">
                    <div class="table-header"><h3 id="form-title"><i class="fas fa-edit"></i> Ingresar Cupo</h3>
                    <button id="close-win" class="btn btn-outline"><i class="fa-solid fa-xmark"></i></button></div>
                        <form id="role-form">
                             <input type="hidden" id="id_rol">
                            <div class="form-row">
                                <div class="input-group">
                                    <input type="text" id="modulo" required maxlength="15" placeholder="">
                                    <label for="modulo">Módulo</label>
                                </div>
                                <div class="input-group">
                                    <input type="text" id="perfil" required maxlength="11" placeholder="">
                                    <label for="perfil">Perfil</label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="input-group">
                                    <input type="text" id="componente" required placeholder="">
                                    <label for="componente">Componente</label>
                                </div>
                                <div class="input-group">
                                    <select id="consultar" required>
                                        <option value="">Consultar</option>
                                        <option value="S">Sí</option>
                                        <option value="N">No</option>
                                    </select>
                                    <label for="consultar">Consultar</label>    
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="input-group">
                                    <select id="editar" required>
                                        <option value="">Editar</option>
                                        <option value="S">Sí</option>
                                        <option value="N">No</option>
                                    </select>
                                    <label for="editar">Editar</label>
                                </div>
                                <div class="input-group">
                                    <select id="crear" required>
                                        <option value="">Crear</option>
                                        <option value="S">Sí</option>
                                        <option value="N">No</option>
                                    </select>
                                    <label for="crear">Crear</label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="input-group">
                                    <select id="ajustar" required>
                                        <option value="">Ajustar</option>
                                        <option value="S">Sí</option>
                                        <option value="N">No</option>
                                    </select>
                                    <label for="ajustar">Ajustar</label>
                                </div>
                                <div class="input-group">
                                    <select id="importar" required>
                                        <option value="">Importar</option>
                                        <option value="S">Sí</option>
                                        <option value="N">No</option>
                                    </select>
                                    <label for="importar">Importar</label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="input-group">
                                    <select id="estado" required>
                                        <option value="">Estado</option>
                                        <option value="A">Activo</option>
                                        <option value="I">Inactivo</option>
                                    </select>
                                    <label for="estado">Estado</label>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" id="submit-btn" class="btn btn-primary"><i class="fas fa-save"></i>Guardar</button>
                                <button type="button" id="cancel-btn" class="btn btn-outline"><i class="fas fa-times"></i>Cancelar</button>
                            </div>
                        </form>
                    </div>
     <div class="toast-container">
        <!-- Las notificaciones se agregarán aquí dinámicamente -->
        </div>
</div>


<script src="../lib/js/app.js?v=3"></script>
<script>
    // --- Estado SPA ---
    let editingId = null, roles = [], filters = { search:'', modulo:'', perfil:'', estado:'' };
    let sortField = 'id_rol', sortDir = 'asc', page = 1, pageSize = 10, totalPages = 1;

    // --- Filtros tipo chips ---
    function updateActiveFiltersChips() {
        const chipsList = document.getElementById('active-filters-chips');
        chipsList.innerHTML = '';
        let count = 0;
        if (filters.search) { chipsList.appendChild(createChip('Buscar', filters.search, 'search')); count++; }
        if (filters.modulo) { chipsList.appendChild(createChip('Módulo', filters.modulo, 'modulo')); count++; }
        if (filters.perfil) { chipsList.appendChild(createChip('Perfil', filters.perfil, 'perfil')); count++; }
        if (filters.estado) {
            let label = filters.estado === 'A' ? 'Activo' : 'Inactivo';
            chipsList.appendChild(createChip('Estado', label, 'estado')); count++;
        }
        document.getElementById('active-filters-count').textContent = count;
    }
    function createChip(label, value, key) {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<strong>${label}:</strong> ${value} <button class="chip-remove" title="Quitar filtro" onclick="removeFilter('${key}')">&times;</button>`;
        return chip;
    }
    window.removeFilter = function(key) {
        filters[key] = '';
        if (key === 'search') document.getElementById('fil-search').value = '';
        if (key === 'modulo') document.getElementById('fil-modulo').value = '';
        if (key === 'perfil') document.getElementById('fil-perfil').value = '';
        if (key === 'estado') document.getElementById('fil-estado').value = '';
        page = 1;
        fetchRoles();
        updateActiveFiltersChips();
    };

    // --- Mostrar/ocultar filtros ---
    const filtersPanel = document.getElementById('filters-panel');
    const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
    let filtersVisible = false;
    toggleFiltersBtn.onclick = function() {
        filtersVisible = !filtersVisible;
        filtersPanel.classList.toggle('hidden', !filtersVisible);
    };

    // --- Filtros funcionalidad ---
    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        filters.search = document.getElementById('fil-search').value.trim();
        filters.modulo = document.getElementById('fil-modulo').value.trim();
        filters.perfil = document.getElementById('fil-perfil').value.trim();
        filters.estado = document.getElementById('fil-estado').value;
        page = 1;
        fetchRoles();
        updateActiveFiltersChips();
        filtersPanel.classList.add('hidden');
        filtersVisible = false;
    });
    document.getElementById('clear-filters').onclick = function() {
        document.getElementById('filter-form').reset();
        filters = { search:'', modulo:'', perfil:'', estado:'' };
        page = 1;
        fetchRoles();
        updateActiveFiltersChips();
    };

    // --- Tabla, paginador y ordenamiento ---
    function renderRolesTable(data) {
        roles = data.roles || [];
        totalPages = data.totalPages || 1;
        const tbody = document.querySelector('#roles-table tbody');
        tbody.innerHTML = '';
        roles.forEach(role => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td style="position:relative;">
                    <button class="action-menu-btn" onclick="toggleActionMenu(event, ${role.id_rol})">
                        <i class="fa fa-ellipsis-v"></i>
                    </button>
                    <div class="action-menu" id="action-menu-${role.id_rol}">
                        <button onclick="editRole(${role.id_rol})"><i class="fa fa-edit"></i> Editar</button>
                        <button onclick="deleteRole(${role.id_rol})"><i class="fa fa-trash"></i> Eliminar</button>
                        <!-- Puedes agregar más acciones aquí -->
                    </div>
                </td>
                <td data-label="ID">${role.id_rol}</td>
                <td data-label="Modulo">${role.modulo}</td>
                <td data-label="Perfil">${role.perfil}</td>
                <td data-label="Componente">${role.componente}</td>
                <td data-label="Consultar">${role.consultar}</td>
                <td data-label="Editar">${role.editar}</td>
                <td data-label="Crear">${role.crear}</td>
                <td data-label="Ajustar">${role.ajustar}</td>
                <td data-label="Importar">${role.importar}</td>
                <td data-label="Estado">${role.estado}</td>
            `;
            tbody.appendChild(tr);
        });
        renderPaginator();
        if(window.innerWidth <= 600) {
        if(!document.getElementById('mobile-action-btn')) {
            const btn = document.createElement('button');
            btn.className = 'action-menu-btn';
            btn.id = 'mobile-action-btn';
            btn.innerHTML = '<i class="fa fa-ellipsis-v"></i>';
            btn.onclick = function(e) {
                e.stopPropagation();
                document.getElementById('mobile-action-menu').classList.toggle('show');
            };
            document.body.appendChild(btn);

            const menu = document.createElement('div');
            menu.className = 'action-menu';
            menu.id = 'mobile-action-menu';
            menu.innerHTML = `
                <button onclick="editRoleMobile()"><i class="fa fa-edit"></i> Editar</button>
                <button onclick="deleteRoleMobile()"><i class="fa fa-trash"></i> Eliminar</button>
            `;
            document.body.appendChild(menu);
        }
        // Oculta los botones de acción en cada fila
        document.querySelectorAll('.action-menu-btn').forEach(el => el.style.display = 'none');
        }
    }

    function renderPaginator() {
    const pag = document.getElementById('paginator');
    pag.innerHTML = '';

    const maxButtons = 5;
    let start = Math.max(1, page - Math.floor(maxButtons / 2));
    let end = start + maxButtons - 1;
    if (end > totalPages) {
        end = totalPages;
        start = Math.max(1, end - maxButtons + 1);
    }

    // Botón "Primero"
    if (page > 1) {
        const firstBtn = document.createElement('button');
        firstBtn.innerHTML = '<i class="fa fa-angle-double-left"></i>';
        firstBtn.title = "Primera página";
        firstBtn.onclick = () => { page = 1; fetchRoles(); };
        pag.appendChild(firstBtn);
    }

    // Botón "Anterior"
    if (page > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '<i class="fa fa-angle-left"></i>';
        prevBtn.title = "Anterior";
        prevBtn.onclick = () => { page = page - 1; fetchRoles(); };
        pag.appendChild(prevBtn);
    }

    // Botones de página
    for (let i = start; i <= end; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = (i === page) ? 'active' : '';
        btn.onclick = () => { page = i; fetchRoles(); };
        pag.appendChild(btn);
    }

    // Botón "Siguiente"
    if (page < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '<i class="fa fa-angle-right"></i>';
        nextBtn.title = "Siguiente";
        nextBtn.onclick = () => { page = page + 1; fetchRoles(); };
        pag.appendChild(nextBtn);
    }

    // Botón "Último"
    if (page < totalPages) {
        const lastBtn = document.createElement('button');
        lastBtn.innerHTML = '<i class="fa fa-angle-double-right"></i>';
        lastBtn.title = "Última página";
        lastBtn.onclick = () => { page = totalPages; fetchRoles(); };
        pag.appendChild(lastBtn);
    }
}
    // --- Ordenar por columna ---
    function updateSortIcons() {
    document.querySelectorAll('#roles-table th[data-sort]').forEach(th => {
        const field = th.getAttribute('data-sort');
        const iconSpan = th.querySelector('.sort-icon');
        if (!iconSpan) return;
        if (sortField === field) {
            th.classList.add('sorted');
            // Remueve y vuelve a agregar el icono para reiniciar la animación
            iconSpan.innerHTML = '';
            const icon = document.createElement('i');
            icon.className = sortDir === 'asc' ? 'fa fa-arrow-up' : 'fa fa-arrow-down';
            iconSpan.appendChild(icon);
        } else {
            th.classList.remove('sorted');
            iconSpan.innerHTML = '<i class="fa fa-sort"></i>';
        }
    });
}

// Llama a updateSortIcons() después de ordenar
document.querySelectorAll('#roles-table th[data-sort]').forEach(th => {
    th.onclick = function() {
        const field = th.getAttribute('data-sort');
        if (sortField === field) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
        else { sortField = field; sortDir = 'asc'; }
        page = 1;
        fetchRoles();
        updateSortIcons();
    };
});

    // --- CRUD SPA ---
    document.getElementById('add-btn').onclick = function() {
        editingId = null;
        document.getElementById('role-form').reset();
        // Cambiar dinámicamente el icono y el título del modal
        const formTitle = document.getElementById('form-title');
        formTitle.innerHTML = ''; // Limpiar contenido previo
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-calendar-days';
        formTitle.appendChild(icon);
        formTitle.appendChild(document.createTextNode(' Nuevo Rol'));
        document.getElementById('modal-bg').classList.remove('hidden');
        document.getElementById('table-section').classList.add('hidden');
    };
    document.getElementById('cancel-btn').onclick = function() {
        document.getElementById('modal-bg').classList.add('hidden');
        document.getElementById('table-section').classList.remove('hidden');
    };

    document.getElementById('close-win').onclick = function() {
        document.getElementById('modal-bg').classList.add('hidden');
        document.getElementById('table-section').classList.remove('hidden');
    };
    window.editRole = function(id) {
        fetch(`/ajustes/lib.php?a=get&id=${id}`)
            .then(res => res.json())
            .then(role => {
                editingId = role.id_rol;
                document.getElementById('id_rol').value = role.id_rol;
                document.getElementById('modulo').value = role.modulo;
                document.getElementById('perfil').value = role.perfil;
                document.getElementById('componente').value = role.componente;
                document.getElementById('consultar').value = role.consultar;
                document.getElementById('editar').value = role.editar;
                document.getElementById('crear').value = role.crear;
                document.getElementById('ajustar').value = role.ajustar;
                document.getElementById('importar').value = role.importar;
                document.getElementById('estado').value = role.estado;
                document.getElementById('form-title').textContent = 'Editar Rol';
                document.getElementById('table-section').classList.add('hidden');
                document.getElementById('modal-bg').classList.remove('hidden');
                
            });
    };
    window.deleteRole = function(id) {
        if (!confirm('¿Está seguro de eliminar este rol?')) return;
        const formData = new FormData();
        formData.append('csrf_token', window.CSRF_TOKEN);
        fetchWithLoader(`/ajustes/lib.php?a=delete&id=${id}`, {
            method: 'POST',
            body: formData
        }, () => fetchRoles());
    };
    document.getElementById('role-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        if (editingId) formData.append('id_rol', editingId);
        // Agrega el token CSRF
        formData.append('csrf_token', window.CSRF_TOKEN);

        fetchWithLoader(`/ajustes/lib.php?a=${editingId ? 'update' : 'create'}`, {
            method: 'POST',
            body: formData
        }, () => {
            document.getElementById('modal-bg').classList.add('hidden');
            fetchRoles();
        });
    });

    // --- Fetch roles con filtros, paginador y orden ---
    function fetchRoles() {
        showLoader();
        const params = new URLSearchParams({
            ...filters,
            sort: sortField,
            dir: sortDir,
            page,
            pageSize
        }).toString();
        fetch(`/ajustes/lib.php?a=list&${params}`)
            .then(res => res.json())
            .then(data => {
                hideLoader();
                renderRolesTable(data);
            })
            .catch(() => hideLoader());
    }

    // Inicializar
    fetchRoles();
    updateActiveFiltersChips();

    function validateFormFields(rules) {
    rules.forEach(rule => {
        const el = document.getElementById(rule.field);
        if (el) {
            el.classList.remove('input-error');
            // Elimina mensaje de error anterior
            const msg = el.parentNode.querySelector('.error-message');
            if (msg) msg.remove();
        }
    });
    for (const rule of rules) {
        const el = document.getElementById(rule.field);
        if (!el) continue;
        const value = (el.type === 'checkbox' || el.type === 'radio') ? el.checked : el.value.trim();
        if (!rule.validate(value, el)) {
            showToast(rule.message, 'error');
            if (el.type !== 'hidden' && el.offsetParent !== null) {
                el.classList.add('input-error');
                el.focus();
                // Muestra mensaje de error debajo del input
                let errorMsg = document.createElement('span');
                errorMsg.className = 'error-message';
                errorMsg.textContent = rule.message;
                el.parentNode.appendChild(errorMsg);
            }
            return false;
        }
    }
    return true;
}

function toggleActionMenu(e, id) {
    e.stopPropagation();
    // Oculta otros menús abiertos
    document.querySelectorAll('.action-menu.show').forEach(menu => menu.classList.remove('show'));
    // Muestra el menú de este registro
    const menu = document.getElementById(`action-menu-${id}`);
    if (menu) menu.classList.toggle('show');
}

// Oculta el menú contextual al hacer clic fuera
document.addEventListener('click', () => {
    document.querySelectorAll('.action-menu.show').forEach(menu => menu.classList.remove('show'));
});
window.addEventListener('scroll', () => {
  document.querySelectorAll('.action-menu.show').forEach(menu => menu.classList.remove('show'));
});
</script>
</body>
</html>