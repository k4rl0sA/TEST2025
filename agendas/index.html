<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamiento de Citas de Salud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="bg-blue-600 text-white p-6 rounded-lg shadow-lg mb-8">
            <h1 class="text-3xl font-bold">Sistema de Agendamiento de Citas</h1>
            <p class="mt-1">Gestione las citas de sus profesionales de manera fácil y eficiente.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna de Selección y Filtros -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4 border-b pb-2 text-blue-700">Filtros de Búsqueda</h2>
                <div class="space-y-4">
                    <div>
                        <label for="profile" class="block text-sm font-medium text-gray-700 mb-1">Perfil Profesional</label>
                        <select id="profile" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Seleccione un Perfil --</option>
                        </select>
                    </div>
                    <div>
                        <label for="professional" class="block text-sm font-medium text-gray-700 mb-1">Profesional</label>
                        <select id="professional" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" disabled>
                            <option value="">-- Seleccione un Profesional --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Columna de Calendario -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <div id="calendar-container">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-week" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-chevron-left"></i> Semana Anterior</button>
                        <h2 id="week-range" class="text-xl font-bold text-center text-blue-700"></h2>
                        <button id="next-week" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Siguiente Semana <i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendar" class="overflow-x-auto">
                        <!-- El calendario se generará aquí -->
                    </div>
                     <div class="mt-4 text-sm text-gray-600 flex flex-wrap gap-4">
                        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded bg-green-200 border border-green-400"></span> Disponible</div>
                        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded bg-red-200 border border-red-400"></span> Ocupado</div>
                        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded bg-blue-200 border border-blue-400"></span> Realizado</div>
                        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded bg-yellow-200 border border-yellow-400"></span> Reasignado</div>
                    </div>
                </div>
                <div id="no-professional-selected" class="text-center py-16">
                    <i class="fas fa-user-md text-6xl text-gray-300"></i>
                    <p class="mt-4 text-gray-500">Por favor, seleccione un perfil y un profesional para ver su agenda.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Agendamiento -->
    <div id="appointment-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95">
            <div class="bg-blue-600 text-white p-4 rounded-t-lg flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold">Programar Agenda</h3>
                <button id="close-modal" class="text-white hover:text-gray-200 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="appointment-form" class="space-y-4">
                    <input type="hidden" id="slot-date">
                    <input type="hidden" id="slot-time">
                    <input type="hidden" id="slot-professional-id">
                    <input type="hidden" id="appointment-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="doc-type" class="block text-sm font-medium text-gray-700">Tipo de Documento</label>
                            <select id="doc-type" class="w-full p-2 border border-gray-300 rounded-md mt-1">
                                <option>Cédula de Ciudadanía</option>
                                <option>Tarjeta de Identidad</option>
                                <option>Cédula de Extranjería</option>
                                <option>Pasaporte</option>
                            </select>
                        </div>
                        <div>
                            <label for="doc-number" class="block text-sm font-medium text-gray-700">Número de Documento</label>
                            <div class="flex">
                                <input type="text" id="doc-number" class="w-full p-2 border border-gray-300 rounded-l-md mt-1">
                                <button type="button" id="search-patient" class="bg-blue-500 text-white px-4 rounded-r-md mt-1 hover:bg-blue-600"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="patient-info" class="space-y-4 pt-4 border-t">
                         <div>
                            <label for="full-name" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                            <input type="text" id="full-name" class="w-full p-2 border border-gray-300 rounded-md mt-1">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                                <input type="tel" id="phone" class="w-full p-2 border border-gray-300 rounded-md mt-1">
                            </div>
                            <div>
                                <label for="address" class="block text-sm font-medium text-gray-700">Dirección</label>
                                <input type="text" id="address" class="w-full p-2 border border-gray-300 rounded-md mt-1">
                            </div>
                        </div>
                        <div>
                            <label for="activity" class="block text-sm font-medium text-gray-700">Actividad</label>
                            <input type="text" id="activity" class="w-full p-2 border border-gray-300 rounded-md mt-1">
                        </div>
                        <div>
                            <label for="appointment-date" class="block text-sm font-medium text-gray-700">Fecha de Agenda</label>
                            <input type="date" id="appointment-date" class="w-full p-2 border border-gray-300 rounded-md mt-1">
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">Notas / Observaciones</label>
                            <textarea id="notes" rows="3" class="w-full p-2 border border-gray-300 rounded-md mt-1"></textarea>
                        </div>
                    </div>

                    <div id="appointment-status-section" class="pt-4 border-t hidden">
                        <label for="appointment-status" class="block text-sm font-medium text-gray-700">Estado de la Cita</label>
                        <div class="flex items-center gap-4 mt-1">
                            <select id="appointment-status" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="Realizado">Realizado</option>
                                <option value="Reasignado">Reasignado</option>
                            </select>
                            <button type="button" id="update-status-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Actualizar</button>
                        </div>
                         <button type="button" id="reassign-btn" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 hidden">Reasignar Cita</button>
                    </div>

                    <div class="flex justify-end pt-4 border-t">
                        <button type="button" id="cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-2">Cancelar</button>
                        <button type="submit" id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Programar Cita</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATOS DE EJEMPLO ---
            const mockData = {
                profiles: [
                    { id: 1, name: 'Médicos' },
                    { id: 2, name: 'Psicólogos' },
                    { id: 3, name: 'Odontólogos' },
                ],
                professionals: [
                    { id: 101, profileId: 1, name: 'Dr. Carlos Fernández' },
                    { id: 102, profileId: 1, name: 'Dra. Ana Martínez' },
                    { id: 201, profileId: 2, name: 'Psic. María Duarte' },
                    { id: 202, profileId: 2, name: 'Psic. Jorge Rojas' },
                    { id: 301, profileId: 3, name: 'Od. Laura Gómez' },
                ],
                // Simulación de una base de datos de pacientes y citas
                patients: [
                    { docType: 'Cédula de Ciudadanía', docNumber: '12345678', fullName: 'Juan Pérez', phone: '3001234567', address: 'Calle Falsa 123' }
                ],
                appointments: []
            };

            // --- ESTADO DE LA APLICACIÓN ---
            let currentDate = new Date();
            let selectedProfessionalId = null;

            // --- ELEMENTOS DEL DOM ---
            const profileSelect = document.getElementById('profile');
            const professionalSelect = document.getElementById('professional');
            const calendarContainer = document.getElementById('calendar');
            const weekRangeEl = document.getElementById('week-range');
            const prevWeekBtn = document.getElementById('prev-week');
            const nextWeekBtn = document.getElementById('next-week');
            const noProfessionalSelected = document.getElementById('no-professional-selected');
            const calendarView = document.getElementById('calendar-container');

            // Modal elements
            const modal = document.getElementById('appointment-modal');
            const modalTitle = document.getElementById('modal-title');
            const closeModalBtn = document.getElementById('close-modal');
            const cancelBtn = document.getElementById('cancel-btn');
            const form = document.getElementById('appointment-form');
            const searchPatientBtn = document.getElementById('search-patient');
            const docNumberInput = document.getElementById('doc-number');
            const docTypeInput = document.getElementById('doc-type');
            
            const patientInfoFields = ['full-name', 'phone', 'address', 'activity', 'appointment-date', 'notes'];
            const submitBtn = document.getElementById('submit-btn');
            const statusSection = document.getElementById('appointment-status-section');
            const updateStatusBtn = document.getElementById('update-status-btn');
            const reassignBtn = document.getElementById('reassign-btn');
            const appointmentStatusSelect = document.getElementById('appointment-status');


            // --- INICIALIZACIÓN ---
            function init() {
                populateProfiles();
                profileSelect.addEventListener('change', onProfileChange);
                professionalSelect.addEventListener('change', onProfessionalChange);
                prevWeekBtn.addEventListener('click', () => changeWeek(-1));
                nextWeekBtn.addEventListener('click', () => changeWeek(1));
                closeModalBtn.addEventListener('click', closeModal);
                cancelBtn.addEventListener('click', closeModal);
                form.addEventListener('submit', handleFormSubmit);
                searchPatientBtn.addEventListener('click', searchPatient);
                updateStatusBtn.addEventListener('click', updateAppointmentStatus);
                reassignBtn.addEventListener('click', reassignAppointment);
                appointmentStatusSelect.addEventListener('change', () => {
                    reassignBtn.classList.toggle('hidden', appointmentStatusSelect.value !== 'Reasignado');
                });
                
                // FIX: Add event listener to the calendar container for event delegation
                calendarContainer.addEventListener('click', handleCalendarClick);

                updateCalendar();
            }

            // --- LÓGICA DE POBLACIÓN DE DATOS ---
            function populateProfiles() {
                mockData.profiles.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile.id;
                    option.textContent = profile.name;
                    profileSelect.appendChild(option);
                });
            }

            function onProfileChange() {
                const profileId = parseInt(profileSelect.value);
                professionalSelect.innerHTML = '<option value="">-- Seleccione un Profesional --</option>';
                professionalSelect.disabled = true;
                selectedProfessionalId = null;
                updateCalendar();

                if (profileId) {
                    const professionals = mockData.professionals.filter(p => p.profileId === profileId);
                    professionals.forEach(prof => {
                        const option = document.createElement('option');
                        option.value = prof.id;
                        option.textContent = prof.name;
                        professionalSelect.appendChild(option);
                    });
                    professionalSelect.disabled = false;
                }
            }
            
            function onProfessionalChange() {
                selectedProfessionalId = parseInt(professionalSelect.value);
                updateCalendar();
            }

            // --- LÓGICA DEL CALENDARIO ---
            function changeWeek(direction) {
                currentDate.setDate(currentDate.getDate() + 7 * direction);
                updateCalendar();
            }

            function getWeekDays(date) {
                const startOfWeek = new Date(date);
                const day = startOfWeek.getDay();
                const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                startOfWeek.setDate(diff);

                const week = [];
                for (let i = 0; i < 7; i++) {
                    const weekDay = new Date(startOfWeek);
                    weekDay.setDate(startOfWeek.getDate() + i);
                    week.push(weekDay);
                }
                return week;
            }

            function updateCalendar() {
                if (!selectedProfessionalId) {
                    calendarView.classList.add('hidden');
                    noProfessionalSelected.classList.remove('hidden');
                    return;
                }
                calendarView.classList.remove('hidden');
                noProfessionalSelected.classList.add('hidden');

                const weekDays = getWeekDays(currentDate);
                const firstDay = weekDays[0];
                const lastDay = weekDays[6];

                weekRangeEl.textContent = `${firstDay.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })} - ${lastDay.toLocaleDateString('es-ES', { month: 'long', day: 'numeric' })}`;
                
                renderCalendarGrid(weekDays);
            }

            function renderCalendarGrid(weekDays) {
                calendarContainer.innerHTML = '';
                const grid = document.createElement('div');
                grid.className = 'calendar-grid';

                // Header
                grid.innerHTML += `<div class="font-bold text-center p-2 border-b border-r">Cupo</div>`;
                weekDays.forEach(day => {
                    grid.innerHTML += `<div class="font-bold text-center p-2 border-b">${day.toLocaleDateString('es-ES', { weekday: 'short' })}<br>${day.getDate()}/${day.getMonth()+1}</div>`;
                });

                // Slots (8 per day)
                for (let i = 1; i <= 8; i++) {
                    const time = `${+ i}`;
                    grid.innerHTML += `<div class="font-bold text-center p-2 border-r">${time}</div>`;
                    weekDays.forEach(day => {
                        const dateStr = day.toISOString().split('T')[0];
                        const appointment = findAppointment(dateStr, time);
                        
                        let cellClass = 'bg-green-200 hover:bg-green-300 cursor-pointer';
                        let cellContent = 'Disponible';
                        let appointmentId = '';
                        
                        if (appointment) {
                             switch(appointment.status) {
                                case 'Agendado':
                                    cellClass = 'bg-red-200 hover:bg-red-300 cursor-pointer';
                                    cellContent = 'Ocupado';
                                    break;
                                case 'Realizado':
                                    cellClass = 'bg-blue-200 hover:bg-blue-300 cursor-pointer';
                                    cellContent = 'Realizado';
                                    break;
                                case 'Reasignado':
                                     cellClass = 'bg-yellow-200 hover:bg-yellow-300 cursor-pointer';
                                     cellContent = 'Reasignado';
                                     break;
                            }
                            appointmentId = appointment.id;
                        }
                        
                        // FIX: Remove inline onclick and use data attributes
                        grid.innerHTML += `<div class="text-center p-2 border-t text-sm ${cellClass} transition duration-200 calendar-slot" data-date="${dateStr}" data-time="${time}" data-appointment-id="${appointmentId}">${cellContent}</div>`;
                    });
                }
                calendarContainer.appendChild(grid);
            }

            function findAppointment(date, time) {
                return mockData.appointments.find(a => 
                    a.professionalId === selectedProfessionalId &&
                    a.date === date &&
                    a.time === time
                );
            }

            // --- LÓGICA DEL MODAL ---

            // FIX: Create a handler for calendar clicks
            function handleCalendarClick(event) {
                const slot = event.target.closest('.calendar-slot');
                if (!slot) return;

                const date = slot.dataset.date;
                const time = slot.dataset.time;
                const appointmentId = slot.dataset.appointmentId || null;

                openModal(date, time, appointmentId);
            }

            function openModal(date, time, appointmentId = null) {
                form.reset();
                resetModalState();
                
                document.getElementById('slot-date').value = date;
                document.getElementById('slot-time').value = time;
                document.getElementById('slot-professional-id').value = selectedProfessionalId;
                
                const appointment = appointmentId ? mockData.appointments.find(a => a.id === appointmentId) : null;

                if (appointment) {
                    // Cita existente: mostrar información y opciones de estado
                    modalTitle.textContent = 'Detalles de la Cita';
                    fillFormWithAppointmentData(appointment);
                    setFormReadOnly(true);
                    submitBtn.classList.add('hidden');
                    statusSection.classList.remove('hidden');
                    appointmentStatusSelect.value = appointment.status;
                    reassignBtn.classList.toggle('hidden', appointment.status !== 'Reasignado');
                } else {
                    // Nueva cita: mostrar formulario para agendar
                    modalTitle.textContent = 'Programar Agenda';
                    const today = new Date().toISOString().split('T')[0];
                    const maxDate = new Date();
                    maxDate.setDate(maxDate.getDate() + 15);
                    const maxDateStr = maxDate.toISOString().split('T')[0];
                    
                    document.getElementById('appointment-date').value = date;
                    document.getElementById('appointment-date').min = today;
                    document.getElementById('appointment-date').max = maxDateStr;

                    setFormReadOnly(false);
                    submitBtn.classList.remove('hidden');
                    statusSection.classList.add('hidden');
                }

                modal.classList.remove('hidden');
                setTimeout(() => modal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100'), 10);
            }

            function closeModal() {
                modal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }

            function resetModalState() {
                form.reset();
                document.getElementById('appointment-id').value = '';
                patientInfoFields.forEach(id => {
                    const el = document.getElementById(id);
                    el.value = '';
                    el.readOnly = false;
                });
                document.getElementById('doc-type').disabled = false;
                document.getElementById('doc-number').readOnly = false;
                searchPatientBtn.disabled = false;
            }

            function setFormReadOnly(isReadOnly) {
                patientInfoFields.forEach(id => {
                    document.getElementById(id).readOnly = isReadOnly;
                });
                document.getElementById('doc-type').disabled = isReadOnly;
                document.getElementById('doc-number').readOnly = isReadOnly;
                searchPatientBtn.disabled = isReadOnly;
            }

            function fillFormWithAppointmentData(appointment) {
                document.getElementById('appointment-id').value = appointment.id;
                document.getElementById('doc-type').value = appointment.patient.docType;
                document.getElementById('doc-number').value = appointment.patient.docNumber;
                document.getElementById('full-name').value = appointment.patient.fullName;
                document.getElementById('phone').value = appointment.patient.phone;
                document.getElementById('address').value = appointment.patient.address;
                document.getElementById('activity').value = appointment.activity;
                document.getElementById('appointment-date').value = appointment.date;
                document.getElementById('notes').value = appointment.notes;
            }


            // --- LÓGICA DEL FORMULARIO ---
            function searchPatient() {
                const docType = docTypeInput.value;
                const docNumber = docNumberInput.value.trim();
                
                if (!docNumber) {
                    alert('Por favor, ingrese un número de documento.');
                    return;
                }

                const patient = mockData.patients.find(p => p.docNumber === docNumber && p.docType === docType);

                if (patient) {
                    document.getElementById('full-name').value = patient.fullName;
                    document.getElementById('phone').value = patient.phone;
                    document.getElementById('address').value = patient.address;
                    alert('Paciente encontrado.');
                } else {
                    alert('Paciente no encontrado. Por favor, complete la información.');
                    document.getElementById('full-name').value = '';
                    document.getElementById('phone').value = '';
                    document.getElementById('address').value = '';
                    document.getElementById('full-name').focus();
                }
            }

            function handleFormSubmit(e) {
                e.preventDefault();
                
                // Recolectar datos del formulario
                const newAppointment = {
                    id: `APT-${Date.now()}`,
                    professionalId: parseInt(document.getElementById('slot-professional-id').value),
                    date: document.getElementById('appointment-date').value,
                    time: document.getElementById('slot-time').value,
                    status: 'Agendado',
                    patient: {
                        docType: document.getElementById('doc-type').value,
                        docNumber: document.getElementById('doc-number').value.trim(),
                        fullName: document.getElementById('full-name').value.trim(),
                        phone: document.getElementById('phone').value.trim(),
                        address: document.getElementById('address').value.trim(),
                    },
                    activity: document.getElementById('activity').value.trim(),
                    notes: document.getElementById('notes').value.trim(),
                };

                // Validaciones
                if (!newAppointment.patient.fullName || !newAppointment.patient.docNumber) {
                    alert('El nombre completo y el número de documento son obligatorios.');
                    return;
                }

                // Guardar la cita
                mockData.appointments.push(newAppointment);

                // Guardar o actualizar paciente
                const existingPatientIndex = mockData.patients.findIndex(p => p.docNumber === newAppointment.patient.docNumber);
                if (existingPatientIndex > -1) {
                    mockData.patients[existingPatientIndex] = newAppointment.patient;
                } else {
                    mockData.patients.push(newAppointment.patient);
                }

                alert('Cita programada exitosamente.');
                closeModal();
                updateCalendar();
            }

            function updateAppointmentStatus() {
                const appointmentId = document.getElementById('appointment-id').value;
                const newStatus = appointmentStatusSelect.value;
                
                const appointment = mockData.appointments.find(a => a.id === appointmentId);
                if (appointment) {
                    appointment.status = newStatus;
                    alert(`El estado de la cita ha sido actualizado a "${newStatus}".`);
                    if (newStatus !== 'Reasignado') {
                       closeModal();
                    }
                    updateCalendar();
                }
            }
            
            function reassignAppointment() {
                alert("Funcionalidad de reasignación: Por favor, seleccione un nuevo cupo disponible en el calendario para mover esta cita.");
                // Aquí se podría implementar una lógica más compleja, como guardar el ID de la cita a reasignar
                // y al hacer clic en un nuevo cupo, mover los datos en lugar de crear una nueva cita.
                closeModal();
            }

            // Iniciar la aplicación
            init();
        });
    </script>
</body>
</html>